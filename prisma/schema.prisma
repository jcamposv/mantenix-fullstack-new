// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum Role {
  SUPER_ADMIN
  ADMIN_GRUPO // Admin de grupo corporativo (ve todas las empresas del grupo)
  ADMIN_EMPRESA
  JEFE_MANTENIMIENTO // Jefe de mantenimiento (aprueba solicitudes de inventario)
  ENCARGADO_BODEGA // Encargado de bodega (entrega repuestos)
  SUPERVISOR
  TECNICO
  CLIENTE_ADMIN_GENERAL // Admin general que puede ver todas las sedes del cliente y generar alertas
  CLIENTE_ADMIN_SEDE // Admin de sede específica que puede ver progreso de órdenes de su sede
  CLIENTE_OPERARIO // Operario que puede reportar errores/incidencias
}

enum Tier {
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum AuditStatus {
  SUCCESS
  WARNING
  ERROR
}

enum SecurityEventType {
  LOGIN_SUCCESS
  LOGIN_FAILED
  LOGOUT
  PASSWORD_CHANGE
  MFA_ENABLED
  MFA_DISABLED
  ACCOUNT_LOCKED
  ACCOUNT_UNLOCKED
  PERMISSION_DENIED
  SUSPICIOUS_ACTIVITY
}

enum AlertPriority {
  LOW // Baja - No urgente, puede esperar
  MEDIUM // Media - Requiere atención pronto
  HIGH // Alta - Requiere atención inmediata
  CRITICAL // Crítica - Requiere acción inmediata
}

enum AlertType {
  EQUIPMENT_FAILURE // Falla de equipo/maquinaria
  MAINTENANCE_REQUIRED // Mantenimiento correctivo requerido
  PREVENTIVE_MAINTENANCE // Mantenimiento preventivo programado
  SAFETY_ISSUE // Problema de seguridad
  SUPPLY_SHORTAGE // Falta de suministros/materiales
  ENVIRONMENTAL_ISSUE // Problema ambiental (temperatura, humedad, etc.)
  OPERATIONAL_ISSUE // Problema operacional
  OTHER // Otro tipo de problema
}

enum AlertStatus {
  OPEN // Recién creada, sin asignar
  ASSIGNED // Asignada a un técnico
  IN_PROGRESS // En proceso de resolución
  RESOLVED // Resuelta, esperando confirmación
  CLOSED // Cerrada y confirmada
}

enum AssetStatus {
  OPERATIVO // Activo en funcionamiento normal
  EN_MANTENIMIENTO // En proceso de mantenimiento
  FUERA_DE_SERVICIO // No disponible para uso
}

enum FeatureModule {
  // HR Modules
  HR_ATTENDANCE // Módulo de asistencia y marcaje
  HR_VACATIONS // Módulo de vacaciones
  HR_PERMISSIONS // Módulo de permisos

  // AI & Analytics
  AI_ASSISTANT // Asistente de IA (add-on disponible bajo demanda)
  ADVANCED_ANALYTICS // Análisis avanzados

  // Business Models
  EXTERNAL_CLIENT_MANAGEMENT // Gestión de clientes externos (ClientCompany, Sites)
  INTERNAL_CORPORATE_GROUP // Grupo corporativo con inventario compartido

  // Platform Features (nuevos)
  API_ACCESS // Acceso a API REST
  PRIORITY_SUPPORT // Soporte prioritario
  DEDICATED_SUPPORT // Soporte dedicado con account manager
}

enum LocationType {
  SITE // Sede/Site de cliente
  WAREHOUSE // Bodega central de la empresa
  VEHICLE // Vehículo/camión
}

enum InventoryRequestStatus {
  PENDING // Pendiente de aprobación
  APPROVED // Aprobado por jefe
  REJECTED // Rechazado
  IN_TRANSIT // En tránsito (transferencia inter-empresa)
  RECEIVED_AT_DESTINATION // Recibido en bodega destino (inter-empresa)
  READY_FOR_PICKUP // Listo para entrega al técnico
  DELIVERED // Entregado y confirmado por técnico
  CANCELLED // Cancelado
}

enum RequestUrgency {
  LOW
  NORMAL
  HIGH
  CRITICAL
}

enum MovementType {
  IN // Entrada (compra, devolución)
  OUT // Salida (uso, venta)
  TRANSFER // Transferencia entre ubicaciones/empresas
  ADJUSTMENT // Ajuste de inventario
  WORK_ORDER // Consumo en orden de trabajo
  RETURN // Devolución
  DAMAGE // Daño/pérdida
  COUNT_ADJUSTMENT // Ajuste por conteo físico
}

enum AttendanceStatus {
  ON_TIME // A tiempo
  LATE // Tarde
  ABSENT // Ausente
  JUSTIFIED // Justificado
  EARLY_DEPARTURE // Salida temprana
}

// ============================================================================
// BETTER AUTH CORE TABLES (with extensions)
// ============================================================================

model User {
  id            String   @id @default(cuid())
  name          String
  email         String   @unique
  emailVerified Boolean  @default(false)
  image         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Better Auth extension fields (following best practices)
  role            Role      @default(TECNICO)
  companyId       String?
  companyGroupId  String? // For ADMIN_GRUPO users
  isExternalUser  Boolean   @default(false)
  clientCompanyId String?
  siteId          String? // Site assignment for users (optional for company users, required for external users)
  avatar          String?
  timezone        String    @default("UTC")
  locale          String    @default("en")
  preferences     String? // JSON as string
  isLocked        Boolean   @default(false)
  lockedUntil     DateTime?
  lastLoginAt     DateTime?
  lastLoginIp     String?
  mfaEnabled      Boolean   @default(false)
  isMfaVerified   Boolean   @default(false)

  // Relations
  accounts               Account[]
  sessions               Session[]
  company                Company?         @relation(fields: [companyId], references: [id])
  companyGroup           CompanyGroup?    @relation(fields: [companyGroupId], references: [id])
  clientCompany          ClientCompany?   @relation(fields: [clientCompanyId], references: [id])
  site                   Site?            @relation(fields: [siteId], references: [id])
  auditLogs              AuditLog[]
  securityEvents         SecurityEvent[]
  invitationsCreated     UserInvitation[] @relation("UserInvitationsCreated")
  clientCompaniesCreated ClientCompany[]  @relation("ClientCompanyCreator")
  sitesCreated           Site[]           @relation("SiteCreator")

  // Alert relations
  alertComments      AlertComment[] // Comentarios en alertas
  alertsReported     Alert[]             @relation("AlertReporter")
  alertsAssigned     Alert[]             @relation("AlertAssignee")
  alertsResolved     Alert[]             @relation("AlertResolver")
  alertNotifications AlertNotification[]

  // Asset relations - Comentado, responsabilidad movida a WorkOrder
  // assetsResponsible Asset[] @relation("AssetResponsable")

  // Work Order Template relations
  workOrderTemplatesCreated WorkOrderTemplate[] @relation("WorkOrderTemplateCreator")

  // Work Order Prefix relations
  workOrderPrefixesCreated WorkOrderPrefix[] @relation("WorkOrderPrefixCreator")

  // Work Order relations
  workOrdersCreated           WorkOrder[]           @relation("WorkOrderCreator")
  workOrderAssignments        WorkOrderAssignment[] @relation("WorkOrderAssignments")
  workOrderAssignmentsCreated WorkOrderAssignment[] @relation("WorkOrderAssigner")
  workOrderSchedulesCreated   WorkOrderSchedule[]   @relation("WorkOrderScheduleCreator")

  // Password Reset relations
  passwordResetTokens        PasswordResetToken[] @relation("PasswordResetUser")
  passwordResetTokensCreated PasswordResetToken[] @relation("PasswordResetCreator")

  // Attendance relations
  attendanceRecords      AttendanceRecord[]
  companyFeaturesEnabled CompanyFeature[]   @relation("FeatureEnabler")

  // AI relations
  aiUsageLogs AIUsageLog[]

  // Inventory request relations
  inventoryRequestsRequested WorkOrderInventoryRequest[] @relation("InventoryRequestRequester")
  inventoryRequestsReviewed  WorkOrderInventoryRequest[] @relation("InventoryRequestReviewer")
  inventoryRequestsDelivered WorkOrderInventoryRequest[] @relation("InventoryRequestDeliverer")
  inventoryRequestsWarehouseDelivered WorkOrderInventoryRequest[] @relation("InventoryRequestWarehouseDeliverer")
  inventoryRequestsDestinationWarehouseReceived WorkOrderInventoryRequest[] @relation("InventoryRequestDestinationWarehouseReceiver")
  inventoryRequestsReceived  WorkOrderInventoryRequest[] @relation("InventoryRequestReceiver")

  // Inventory movement relations
  inventoryMovementsCreated InventoryMovement[] @relation("InventoryMovementCreator")
  inventoryMovementsApproved InventoryMovement[] @relation("InventoryMovementApprover")

  @@map("user")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@map("account")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
  @@map("verification")
}

// ============================================================================
// BUSINESS LOGIC TABLES
// ============================================================================

model Company {
  id              String    @id @default(cuid())
  name            String
  subdomain       String    @unique
  logo            String?
  logoSmall       String?
  primaryColor    String    @default("#3b82f6")
  secondaryColor  String    @default("#64748b")
  backgroundColor String    @default("#ffffff")
  customFont      String?

  // Company Group (for INTERNAL_CORPORATE_GROUP feature)
  companyGroupId String?

  mfaEnforced     Boolean   @default(false)
  ipWhitelist     String[]  @default([])
  tier            Tier      @default(STARTER)
  isActive        Boolean   @default(true)
  deletedAt       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  companyGroup       CompanyGroup?        @relation(fields: [companyGroupId], references: [id])
  subscription       Subscription?
  users              User[]
  auditLogs          AuditLog[]
  securityEvents     SecurityEvent[]
  invitations        UserInvitation[]
  clientCompanies    ClientCompany[]
  workOrderTemplates WorkOrderTemplate[]
  workOrderPrefixes  WorkOrderPrefix[]
  workOrders         WorkOrder[]
  workOrderSchedules WorkOrderSchedule[]
  emailConfiguration EmailConfiguration?
  features           CompanyFeature[]
  locations          CompanyLocation[]
  attendanceRecords  AttendanceRecord[]
  aiConfig           CompanyAIConfig?
  aiUsageLogs        AIUsageLog[]
  inventoryItems     InventoryItem[]
  inventoryRequestsAsSource WorkOrderInventoryRequest[] @relation("InventoryRequestSourceCompany")
  inventoryMovementsFrom InventoryMovement[] @relation("InventoryMovementFromCompany")
  inventoryMovementsTo InventoryMovement[] @relation("InventoryMovementToCompany")

  @@index([subdomain])
  @@index([isActive])
  @@map("companies")
}

model ClientCompany {
  id          String    @id @default(cuid())
  name        String
  companyId   String? // Company ID or legal ID (cedula juridica)
  logo        String? // Logo image URL
  address     String?
  phone       String?
  email       String?
  contactName String?
  latitude    Float? // Location coordinates
  longitude   Float? // Location coordinates
  notes       String?
  isActive    Boolean   @default(true)
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  tenantCompanyId String // The tenant company this client belongs to
  tenantCompany   Company @relation(fields: [tenantCompanyId], references: [id], onDelete: Cascade)
  createdBy       String // User who created this client company
  createdByUser   User    @relation("ClientCompanyCreator", fields: [createdBy], references: [id], onDelete: Restrict)

  // External users belonging to this client company
  externalUsers   User[]
  userInvitations UserInvitation[]

  // Sites belonging to this client company
  sites Site[]

  @@index([tenantCompanyId])
  @@index([isActive])
  @@map("client_companies")
}

model Site {
  id          String    @id @default(cuid())
  name        String
  address     String?
  phone       String?
  email       String?
  contactName String?
  latitude    Float? // Location coordinates
  longitude   Float? // Location coordinates
  timezone    String    @default("UTC")
  notes       String?
  isActive    Boolean   @default(true)
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  clientCompanyId String
  clientCompany   ClientCompany @relation(fields: [clientCompanyId], references: [id], onDelete: Cascade)
  createdBy       String
  createdByUser   User          @relation("SiteCreator", fields: [createdBy], references: [id], onDelete: Restrict)

  // Users assigned to this site
  siteUsers       User[]
  userInvitations UserInvitation[]

  // Alerts for this site
  alerts Alert[]

  // Assets in this site
  assets Asset[]

  // Work orders in this site
  workOrders WorkOrder[]
  schedules  WorkOrderSchedule[]

  @@index([clientCompanyId])
  @@index([isActive])
  @@map("sites")
}

model Asset {
  id               String      @id @default(cuid())
  name             String // Asset descriptive name
  code             String // Internal code or serial number
  description      String? // Asset details, usage, or technical information
  location         String // Location within the site
  images           String[]    @default([]) // Array of image URLs
  registrationDate DateTime    @default(now()) // Date when the asset was registered
  status           AssetStatus @default(OPERATIVO) // Current asset status

  // Optional technical fields
  manufacturer      String? // Asset brand or manufacturer
  model             String? // Model or technical reference
  serialNumber      String? // Physical serial number
  purchaseDate      DateTime? // Acquisition date
  estimatedLifespan Int? // Estimated lifespan in years
  // lastRevision         DateTime?   // Last maintenance performed - Moved to WorkOrder
  // nextMaintenance      DateTime?   // Next suggested preventive maintenance date - Moved to WorkOrder
  category          String? // Asset type (vehicle, machinery, tool, etc.)
  customFields      Json? // Custom fields per company

  // Status control
  isActive  Boolean   @default(true)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  siteId String // Relation to the site where it's located
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)
  // responsibleId        String?     // Responsible user or assigned technician - Moved to WorkOrder
  // responsible          User?       @relation("AssetResponsible", fields: [responsibleId], references: [id], onDelete: SetNull)

  // Work orders related to this asset
  workOrders WorkOrder[]
  schedules  WorkOrderSchedule[]

  @@unique([code, siteId]) // Code must be unique per site
  @@index([siteId])
  @@index([status])
  @@index([category])
  // @@index([responsibleId])   // Commented - Moved to WorkOrder
  @@index([isActive])
  // @@index([nextMaintenance]) // Commented - Moved to WorkOrder
  @@map("assets")
}

model AuditLog {
  id         String      @id @default(cuid())
  companyId  String
  userId     String?
  action     String
  resource   String
  resourceId String?
  ipAddress  String
  userAgent  String?
  status     AuditStatus @default(SUCCESS)
  details    String?
  createdAt  DateTime    @default(now())

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([companyId, createdAt])
  @@index([userId, createdAt])
  @@index([action, companyId])
  @@map("audit_logs")
}

model SecurityEvent {
  id          String            @id @default(cuid())
  companyId   String
  userId      String?
  type        SecurityEventType
  severity    String            @default("INFO")
  description String
  ipAddress   String
  userAgent   String?
  metadata    String? // JSON as string
  resolved    Boolean           @default(false)
  resolvedAt  DateTime?
  resolvedBy  String?
  createdAt   DateTime          @default(now())

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([companyId, createdAt])
  @@index([userId, createdAt])
  @@index([type, severity])
  @@index([resolved])
  @@map("security_events")
}

model UserInvitation {
  id              String    @id @default(cuid())
  email           String
  role            Role
  companyId       String?   // Optional for SUPER_ADMIN and ADMIN_GRUPO
  isExternalUser  Boolean   @default(false)
  clientCompanyId String?
  siteId          String? // Site assignment for the invited user
  token           String    @unique
  expiresAt       DateTime
  used            Boolean   @default(false)
  usedAt          DateTime?
  createdBy       String
  image           String? // Profile photo URL for the invited user
  createdAt       DateTime  @default(now())

  // Relations
  company       Company?       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  creator       User           @relation("UserInvitationsCreated", fields: [createdBy], references: [id], onDelete: Cascade)
  clientCompany ClientCompany? @relation(fields: [clientCompanyId], references: [id], onDelete: SetNull)
  site          Site?          @relation(fields: [siteId], references: [id], onDelete: SetNull)

  @@index([email])
  @@index([token])
  @@index([companyId])
  @@index([createdBy])
  @@index([clientCompanyId])
  @@index([siteId])
  @@map("user_invitations")
}

// ============================================================================
// ALERTS SYSTEM
// ============================================================================

model Alert {
  id          String        @id @default(cuid())
  title       String // Título corto de la alerta
  description String // Descripción detallada del problema
  type        AlertType // Tipo de alerta (falla de equipo, mantenimiento, etc.)
  priority    AlertPriority // Prioridad de la alerta
  status      AlertStatus   @default(OPEN) // Estado actual de la alerta

  // Información de ubicación específica (opcional)
  location    String? // Ubicación específica dentro de la sede (ej: "Sala de máquinas A", "Oficina 201")
  equipmentId String? // ID del equipo afectado (si aplica)

  // Multimedia attachments
  images    String[] // Array de URLs de imágenes
  documents String[] // Array de URLs de documentos

  // Metadata
  estimatedResolutionTime Int? // Tiempo estimado de resolución en minutos
  actualResolutionTime    Int? // Tiempo real de resolución en minutos
  resolutionNotes         String? // Notas sobre cómo se resolvió

  // Timestamps
  reportedAt DateTime  @default(now()) // Cuando se reportó la alerta
  assignedAt DateTime? // Cuando se asignó a un técnico
  resolvedAt DateTime? // Cuando se marcó como resuelta
  closedAt   DateTime? // Cuando se cerró la alerta
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relations - Asociada a una sede específica
  siteId String
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // Usuario que reportó la alerta
  reportedById String
  reportedBy   User   @relation("AlertReporter", fields: [reportedById], references: [id], onDelete: Restrict)

  // Usuario asignado para resolver la alerta (técnico)
  assignedToId String?
  assignedTo   User?   @relation("AlertAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)

  // Usuario que resolvió la alerta
  resolvedById String?
  resolvedBy   User?   @relation("AlertResolver", fields: [resolvedById], references: [id], onDelete: SetNull)

  // Historial de comentarios/actualizaciones
  comments      AlertComment[]
  notifications AlertNotification[]

  @@index([siteId, status])
  @@index([priority, status])
  @@index([reportedById])
  @@index([assignedToId])
  @@index([type])
  @@index([reportedAt])
  @@map("alerts")
}

model AlertComment {
  id         String   @id @default(cuid())
  content    String // Contenido del comentario
  isInternal Boolean  @default(false) // Si es un comentario interno (solo para técnicos) o público
  createdAt  DateTime @default(now())

  // Relations
  alertId  String
  alert    Alert  @relation(fields: [alertId], references: [id], onDelete: Cascade)
  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Restrict)

  @@index([alertId])
  @@index([authorId])
  @@map("alert_comments")
}

model AlertNotification {
  id           String    @id @default(cuid())
  type         String // Tipo de notificación: "email", "push", "in_app"
  status       String    @default("pending") // "pending", "sent", "delivered", "failed"
  sentAt       DateTime?
  deliveredAt  DateTime?
  errorMessage String?
  metadata     String? // JSON con datos adicionales (email template, push payload, etc.)
  createdAt    DateTime  @default(now())

  // Relations
  alertId String
  alert   Alert  @relation(fields: [alertId], references: [id], onDelete: Cascade)
  userId  String // Usuario que debe recibir la notificación
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([alertId])
  @@index([userId])
  @@index([status])
  @@index([type])
  @@map("alert_notifications")
}

// ============================================================================
// WORK ORDER TEMPLATES SYSTEM
// ============================================================================

enum WorkOrderTemplateStatus {
  ACTIVE
  INACTIVE
}

enum WorkOrderType {
  PREVENTIVO
  CORRECTIVO
  REPARACION
}

enum WorkOrderPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum WorkOrderStatus {
  DRAFT // Borrador
  ASSIGNED // Asignada
  IN_PROGRESS // En progreso
  COMPLETED // Completada
  CANCELLED // Cancelada
}

enum RecurrenceType {
  DAILY // Diario
  WEEKLY // Semanal
  MONTHLY // Mensual
  YEARLY // Anual
  METER_BASED // Basado en lecturas de medidores
}

enum RecurrenceEndType {
  NEVER // Sin fin
  AFTER_OCCURRENCES // Después de X ocurrencias
  ON_DATE // En fecha específica
}

enum MeterType {
  HOURS_RUN // Horas de funcionamiento
  KILOMETERS // Kilómetros
  MILES // Millas
  TEMPERATURE // Temperatura
  PRESSURE // Presión
  CYCLES // Ciclos de operación
  VIBRATION // Vibración
  CUSTOM // Personalizado
}

enum CustomFieldType {
  TEXT // Input de texto simple
  TEXTAREA // Área de texto multilinea
  NUMBER // Input numérico
  SELECT // Select con opciones predefinidas
  RADIO // Radio buttons
  CHECKBOX // Checkbox individual
  CHECKLIST // Lista de checkboxes (instrucciones)
  DATE // Selector de fecha
  TIME // Selector de hora
  DATETIME // Selector de fecha y hora
  IMAGE_BEFORE // Campo para imágenes antes
  IMAGE_AFTER // Campo para imágenes después
  VIDEO_BEFORE // Campo para videos antes
  VIDEO_AFTER // Campo para videos después
  FILE // Campo para archivos generales
  TABLE // Tabla con filas y columnas configurables
}

enum EmailTemplateType {
  WELCOME // Email de bienvenida
  USER_INVITATION // Invitación de usuario
  PASSWORD_RESET // Reseteo de contraseña
  WORK_ORDER_CREATED // Orden de trabajo creada
  WORK_ORDER_COMPLETED // Orden de trabajo completada
  WORK_ORDER_CANCELLED // Orden de trabajo cancelada
  ALERT_CREATED // Alerta creada
  ALERT_ASSIGNED // Alerta asignada
  ALERT_RESOLVED // Alerta resuelta
}

model WorkOrderTemplate {
  id          String                  @id @default(cuid())
  name        String // Nombre del template
  description String? // Descripción del template
  category    String? // Categoría del template (Preventivo, Correctivo, etc.)
  status      WorkOrderTemplateStatus @default(ACTIVE) // Estado del template

  // Campos personalizados dinámicos - Estructura JSON que define los campos
  customFields Json? // Configuración de campos personalizados
  // Estructura ejemplo:
  // {
  //   "fields": [
  //     {
  //       "id": "checklist_1",
  //       "type": "CHECKLIST",
  //       "label": "Pasos de mantenimiento",
  //       "required": true,
  //       "options": ["Revisar aceite", "Cambiar filtro", "Limpiar componentes"],
  //       "order": 1
  //     },
  //     {
  //       "id": "condition_select",
  //       "type": "SELECT",
  //       "label": "Condición del equipo",
  //       "required": true,
  //       "options": ["Excelente", "Bueno", "Regular", "Malo"],
  //       "order": 2
  //     },
  //     {
  //       "id": "images_before",
  //       "type": "IMAGE_BEFORE",
  //       "label": "Fotos antes del mantenimiento",
  //       "required": true,
  //       "order": 3
  //     }
  //   ]
  // }

  // Control de acceso y propiedad
  companyId String // Empresa propietaria del template
  createdBy String // Usuario que creó el template

  // Timestamps
  isActive  Boolean   @default(true)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  creator User    @relation("WorkOrderTemplateCreator", fields: [createdBy], references: [id], onDelete: Restrict)

  // Relations with work orders
  workOrders WorkOrder[] @relation("WorkOrderFromTemplate")
  schedules  WorkOrderSchedule[]

  @@index([companyId])
  @@index([status])
  @@index([category])
  @@index([isActive])
  @@index([createdBy])
  @@map("work_order_templates")
}

// ============================================================================
// WORK ORDERS SYSTEM
// ============================================================================

// Prefijos configurables para números de órdenes de trabajo
model WorkOrderPrefix {
  id          String  @id @default(cuid())
  code        String // Código del prefijo (ej: "NR", "VH", "PROY01")
  name        String // Nombre descriptivo del prefijo
  description String? // Descripción opcional del uso del prefijo

  // Control de acceso y propiedad
  companyId String // Empresa propietaria
  createdBy String // Usuario que creó el prefijo

  // Timestamps
  isActive  Boolean   @default(true)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  company    Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  creator    User        @relation("WorkOrderPrefixCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  workOrders WorkOrder[]

  @@unique([companyId, code]) // Código único por empresa
  @@index([companyId])
  @@index([isActive])
  @@index([createdBy])
  @@map("work_order_prefixes")
}

model WorkOrder {
  id          String  @id @default(cuid())
  number      String // Número único de la orden (ej: NR0001, VH0256)
  prefixId    String? // Prefijo opcional para la numeración
  title       String // Título de la orden
  description String? // Descripción de la orden

  // Clasificación
  type     WorkOrderType // PREVENTIVO, CORRECTIVO, REPARACION
  priority WorkOrderPriority @default(MEDIUM) // Prioridad de la orden
  status   WorkOrderStatus   @default(DRAFT) // Estado de la orden

  // Ubicación y activo (opcional cuando EXTERNAL_CLIENT_MANAGEMENT está deshabilitado)
  siteId  String? // Sede donde se ejecuta (opcional)
  assetId String? // Activo relacionado (opcional)

  // Template relacionado (opcional)
  templateId        String? // Template base usado
  customFieldValues Json? // Valores de campos personalizados del template

  // Programación recurrente (para mantenimiento preventivo)
  isRecurring Boolean @default(false) // Si fue generada automáticamente
  scheduleId  String? // Programación que generó esta OT
  schedule    WorkOrderSchedule? @relation("GeneratedFromSchedule", fields: [scheduleId], references: [id], onDelete: SetNull)

  // Fechas importantes
  scheduledDate DateTime? // Fecha programada
  startedAt     DateTime? // Fecha de inicio real
  completedAt   DateTime? // Fecha de finalización

  // Estimaciones y costos
  estimatedDuration Int? // Duración estimada en minutos
  estimatedCost     Float? // Costo estimado
  actualDuration    Int? // Duración real en minutos
  actualCost        Float? // Costo real

  // Instrucciones y seguridad
  instructions String? // Instrucciones específicas
  safetyNotes  String? // Notas de seguridad
  tools        String[] @default([]) // Herramientas necesarias
  materials    String[] @default([]) // Materiales necesarios

  // Observaciones y notas finales
  observations    String? // Observaciones durante la ejecución
  completionNotes String? // Notas de finalización

  // Control de acceso y propiedad
  companyId String // Empresa propietaria
  createdBy String // Usuario que creó la orden

  // Timestamps
  isActive  Boolean   @default(true)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  company  Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  site     Site?              @relation(fields: [siteId], references: [id], onDelete: Restrict)
  asset    Asset?             @relation(fields: [assetId], references: [id], onDelete: SetNull)
  template WorkOrderTemplate? @relation("WorkOrderFromTemplate", fields: [templateId], references: [id], onDelete: SetNull)
  prefix   WorkOrderPrefix?   @relation(fields: [prefixId], references: [id], onDelete: SetNull)
  creator  User               @relation("WorkOrderCreator", fields: [createdBy], references: [id], onDelete: Restrict)

  // Assignments (many-to-many relationship for multiple users)
  assignments WorkOrderAssignment[]

  // Inventory requests
  inventoryRequests WorkOrderInventoryRequest[]

  // Inventory movements
  inventoryMovements InventoryMovement[]

  @@unique([companyId, number]) // Número único por empresa
  @@index([companyId])
  @@index([siteId])
  @@index([assetId])
  @@index([templateId])
  @@index([scheduleId])
  @@index([prefixId])
  @@index([status])
  @@index([type])
  @@index([priority])
  @@index([scheduledDate])
  @@index([createdBy])
  @@index([isActive])
  @@index([isRecurring])
  @@map("work_orders")
}

// Tabla intermedia para asignaciones de usuarios a órdenes de trabajo
model WorkOrderAssignment {
  id          String   @id @default(cuid())
  workOrderId String
  userId      String
  assignedAt  DateTime @default(now())
  assignedBy  String // Usuario que hizo la asignación

  // Relations
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  user      User      @relation("WorkOrderAssignments", fields: [userId], references: [id], onDelete: Cascade)
  assigner  User      @relation("WorkOrderAssigner", fields: [assignedBy], references: [id], onDelete: Restrict)

  @@unique([workOrderId, userId]) // Un usuario solo puede estar asignado una vez por orden
  @@index([workOrderId])
  @@index([userId])
  @@index([assignedBy])
  @@map("work_order_assignments")
}

// ============================================================================
// WORK ORDER SCHEDULING & RECURRENCE
// ============================================================================

// Programación de órdenes de trabajo recurrentes (Mantenimiento Preventivo)
model WorkOrderSchedule {
  id String @id @default(cuid())

  // Información básica
  name        String // Nombre descriptivo de la programación
  description String? // Descripción opcional

  // Configuración de recurrencia
  recurrenceType     RecurrenceType // Tipo de recurrencia
  recurrenceInterval Int            @default(1) // Cada cuántos días/semanas/meses (ej: cada 2 semanas)

  // Fin de recurrencia
  recurrenceEndType  RecurrenceEndType // Cómo termina la recurrencia
  recurrenceEndValue Int? // Número de ocurrencias (solo si recurrenceEndType = AFTER_OCCURRENCES)
  recurrenceEndDate  DateTime? // Fecha de fin (solo si recurrenceEndType = ON_DATE)

  // Días de la semana (para recurrencia WEEKLY)
  // [1,2,3,4,5] = Lun-Vie, [6,7] = Fin de semana
  weekDays Int[] @default([])

  // Para mantenimiento basado en medidores (METER_BASED)
  meterType           MeterType? // Tipo de medidor
  meterThreshold      Float? // Umbral para generar OT (ej: cada 100 horas)
  currentMeterReading Float      @default(0) // Lectura actual del medidor

  // Template a usar para generar las OT
  templateId String
  template   WorkOrderTemplate @relation(fields: [templateId], references: [id], onDelete: Restrict)

  // Asset relacionado (opcional)
  assetId String?
  asset   Asset?  @relation(fields: [assetId], references: [id], onDelete: SetNull)

  // Site relacionado (opcional)
  siteId String?
  site   Site?   @relation(fields: [siteId], references: [id], onDelete: SetNull)

  // Asignación predefinida
  assignedUserIds String[] @default([]) // IDs de usuarios asignados automáticamente

  // Tracking de generación
  lastGeneratedAt    DateTime? // Última vez que se generó una OT
  nextGenerationDate DateTime? // Próxima fecha programada

  // Estadísticas
  totalGenerated     Int @default(0) // Total de OT generadas
  totalCompleted     Int @default(0) // Total completadas
  totalSkipped       Int @default(0) // Total saltadas
  completionRate     Float @default(0) // % de completitud

  // Control de acceso y propiedad
  companyId String // Empresa propietaria
  createdBy String // Usuario que creó la programación

  // Estado
  isActive  Boolean   @default(true)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  creator User    @relation("WorkOrderScheduleCreator", fields: [createdBy], references: [id], onDelete: Restrict)

  // Órdenes generadas por esta programación
  generatedWorkOrders WorkOrder[] @relation("GeneratedFromSchedule")

  @@index([companyId])
  @@index([templateId])
  @@index([assetId])
  @@index([siteId])
  @@index([isActive])
  @@index([nextGenerationDate])
  @@index([recurrenceType])
  @@map("work_order_schedules")
}

// ============================================================================
// EMAIL SYSTEM
// ============================================================================

// Configuración de MailerSend por tenant company
model EmailConfiguration {
  id        String @id @default(cuid())
  companyId String @unique // Una configuración por tenant company

  // MailerSend API credentials
  apiToken     String // MailerSend API Token
  domainId     String? // Domain ID en MailerSend
  fromEmail    String // Email desde el cual se envían los correos
  fromName     String // Nombre que aparece como remitente
  replyToEmail String? // Email de respuesta (opcional)

  // Settings
  isActive  Boolean   @default(true)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  company        Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  emailTemplates EmailTemplate[]

  @@index([companyId])
  @@index([isActive])
  @@map("email_configurations")
}

// Templates de email personalizables
model EmailTemplate {
  id                   String            @id @default(cuid())
  emailConfigurationId String // Configuración de email asociada
  type                 EmailTemplateType // Tipo de template

  // Template info
  name       String // Nombre descriptivo del template
  subject    String // Asunto del email
  templateId String? // ID del template en MailerSend (opcional)

  // Settings
  isActive  Boolean   @default(true)
  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  emailConfiguration EmailConfiguration @relation(fields: [emailConfigurationId], references: [id], onDelete: Cascade)

  @@unique([emailConfigurationId, type]) // Un template de cada tipo por configuración
  @@index([emailConfigurationId])
  @@index([type])
  @@index([isActive])
  @@map("email_templates")
}

// ============================================================================
// PASSWORD RESET TOKENS
// ============================================================================

// Tokens para reseteo de contraseña enviados por administradores
model PasswordResetToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String // Usuario que recibirá el reset
  createdBy String // Admin que generó el reset
  expiresAt DateTime
  used      Boolean   @default(false)
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  user    User @relation("PasswordResetUser", fields: [userId], references: [id], onDelete: Cascade)
  creator User @relation("PasswordResetCreator", fields: [createdBy], references: [id], onDelete: Restrict)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@index([used])
  @@map("password_reset_tokens")
}

// ============================================================================
// PREMIUM FEATURES SYSTEM
// ============================================================================

// Features habilitadas por empresa
model CompanyFeature {
  id         String        @id @default(cuid())
  companyId  String
  module     FeatureModule // Módulo habilitado
  isEnabled  Boolean       @default(true)
  enabledAt  DateTime      @default(now())
  enabledBy  String? // Usuario que habilitó el feature
  disabledAt DateTime?
  disabledBy String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  // Relations
  company       Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  enabledByUser User?   @relation("FeatureEnabler", fields: [enabledBy], references: [id], onDelete: SetNull)

  @@unique([companyId, module]) // Una empresa solo puede tener un registro por módulo
  @@index([companyId])
  @@index([module])
  @@index([isEnabled])
  @@map("company_features")
}

// Ubicaciones/oficinas de la empresa para geofencing
model CompanyLocation {
  id           String  @id @default(cuid())
  companyId    String
  name         String // Nombre de la ubicación (ej: "Oficina Central", "Bodega Norte")
  address      String?
  latitude     Float // Coordenada para geofencing
  longitude    Float // Coordenada para geofencing
  radiusMeters Int     @default(100) // Radio en metros para considerar que está "dentro"

  // Horarios de trabajo
  workStartTime        String   @default("08:00") // Hora de entrada esperada (formato HH:mm)
  workEndTime          String   @default("17:00") // Hora de salida esperada (formato HH:mm)
  lateToleranceMinutes Int      @default(15) // Tolerancia en minutos antes de marcar como tarde
  timezone             String   @default("America/Costa_Rica") // Timezone de la ubicación
  workDays             String[] @default(["MON", "TUE", "WED", "THU", "FRI"]) // Días laborales

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company           Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  attendanceRecords AttendanceRecord[]

  @@index([companyId])
  @@index([isActive])
  @@map("company_locations")
}

// ============================================================================
// HR / ATTENDANCE SYSTEM
// ============================================================================

model AttendanceRecord {
  id         String  @id @default(cuid())
  companyId  String
  userId     String
  locationId String? // Ubicación desde donde marcó (opcional)

  // Geolocalización
  latitude  Float
  longitude Float

  // Marcaje de entrada/salida
  checkInAt  DateTime
  checkOutAt DateTime?

  // Estado y metadata
  status        AttendanceStatus // ON_TIME, LATE, ABSENT, JUSTIFIED, etc.
  notes         String? // Notas opcionales (ej: justificación)
  isManualEntry Boolean          @default(false) // Si fue creado manualmente por admin
  manualEntryBy String? // Usuario que creó la entrada manual
  deviceInfo    String? // Información del dispositivo (user agent)
  ipAddress     String?

  // Tiempos calculados
  workDurationMinutes Int? // Duración en minutos (checkOut - checkIn)
  lateMinutes         Int? // Minutos de retraso si llegó tarde

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company  Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  location CompanyLocation? @relation(fields: [locationId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([userId])
  @@index([locationId])
  @@index([checkInAt])
  @@index([status])
  @@index([companyId, userId, checkInAt]) // Para búsquedas de asistencia por usuario y fecha
  @@map("attendance_records")
}

// ============================================================================
// AI / ARTIFICIAL INTELLIGENCE SYSTEM
// ============================================================================

enum AIOperationType {
  INSIGHTS_GENERATION // Generación de insights para dashboard
  REPORT_GENERATION // Generación de reportes
  ANOMALY_DETECTION // Detección de anomalías
  PREDICTIVE_ANALYSIS // Análisis predictivo
  RECOMMENDATION // Recomendaciones
}

// Configuración de IA por empresa
model CompanyAIConfig {
  id        String @id @default(cuid())
  companyId String @unique

  // Límites mensuales
  monthlyTokenLimit     Int @default(100000) // Límite de tokens por mes
  alertThresholdPercent Int @default(80) // % para alertar (80% = alerta al llegar a 80%)

  // Estado actual del mes
  currentMonthTokens Int      @default(0) // Tokens usados en el mes actual
  lastResetAt        DateTime @default(now()) // Última vez que se reinició el contador

  // Configuración de features
  insightsEnabled   Boolean @default(true) // Habilitar insights en dashboard
  reportsEnabled    Boolean @default(true) // Habilitar generación de reportes
  predictiveEnabled Boolean @default(false) // Habilitar análisis predictivo

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("company_ai_configs")
}

// Log de uso de IA (para tracking y billing)
model AIUsageLog {
  id        String  @id @default(cuid())
  companyId String
  userId    String? // Usuario que generó la solicitud (opcional)

  // Detalles de la operación
  operation        AIOperationType
  model            String // Modelo usado (gpt-4, gpt-3.5-turbo, etc.)
  promptTokens     Int // Tokens del prompt
  completionTokens Int // Tokens de la respuesta
  totalTokens      Int // Total de tokens
  cost             Float? // Costo estimado en USD

  // Metadata
  success      Boolean @default(true)
  errorMessage String?
  duration     Int? // Duración en ms
  metadata     Json? // Datos adicionales (fecha range, filtros, etc.)

  createdAt DateTime @default(now())

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([userId])
  @@index([operation])
  @@index([createdAt])
  @@index([companyId, createdAt]) // Para queries de uso mensual
  @@map("ai_usage_logs")
}

// ============================================================================
// COMPANY GROUP & INVENTORY MODELS
// ============================================================================

model CompanyGroup {
  id          String  @id @default(cuid())
  name        String // "Grupo Industrial XYZ"
  description String?
  logo        String? // Logo URL del grupo corporativo

  // Settings
  shareInventory       Boolean @default(true) // Compartir inventario entre empresas
  autoApproveTransfers Boolean @default(false) // Aprobar transferencias automáticamente

  // Relations
  companies Company[]
  users     User[] // ADMIN_GRUPO users

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("company_groups")
}

model InventoryItem {
  id          String  @id @default(cuid())
  code        String // SKU único
  name        String
  description String?
  category    String?
  subcategory String?

  // Specifications
  manufacturer String?
  model        String?
  partNumber   String?

  // Units
  unit         String @default("unidad") // "unidad", "litro", "kg", "metro"
  minStock     Int    @default(0) // Stock mínimo
  maxStock     Int? // Stock máximo
  reorderPoint Int    @default(0) // Punto de reorden

  // Costs
  unitCost          Float?
  lastPurchasePrice Float?
  averageCost       Float?

  // Media
  images String[] @default([])

  // Company ownership
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Relations
  stockLocations    InventoryStock[]
  movements         InventoryMovement[]
  workOrderRequests WorkOrderInventoryRequest[]

  isActive  Boolean   @default(true)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  @@unique([companyId, code])
  @@index([companyId])
  @@index([category])
  @@map("inventory_items")
}

model InventoryStock {
  id String @id @default(cuid())

  // Item
  inventoryItemId String
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id], onDelete: Cascade)

  // Location
  locationId   String
  locationType LocationType
  locationName String // Para búsqueda

  // Quantities
  quantity          Int @default(0)
  reservedQuantity  Int @default(0) // Reservado en OTs pendientes
  availableQuantity Int @default(0) // quantity - reservedQuantity (calculado)

  // Ubicación específica dentro del lugar
  aisle String? // Pasillo
  rack  String? // Estante
  bin   String? // Contenedor

  lastCountDate DateTime?
  lastCountBy   String?

  updatedAt DateTime @updatedAt

  @@unique([inventoryItemId, locationId, locationType])
  @@index([inventoryItemId])
  @@index([locationId, locationType])
  @@map("inventory_stock")
}

model WorkOrderInventoryRequest {
  id String @id @default(cuid())

  // Work Order
  workOrderId String
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  // Item requested
  inventoryItemId String
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])

  // Quantities
  quantityRequested Int
  quantityApproved  Int?
  quantityDelivered Int  @default(0)

  // Source (de dónde se solicita)
  sourceCompanyId String?
  sourceCompany   Company? @relation("InventoryRequestSourceCompany", fields: [sourceCompanyId], references: [id])
  sourceLocationId   String?
  sourceLocationType LocationType?

  // Destination (a dónde va)
  destinationLocationId   String?
  destinationLocationType LocationType?

  // Status
  status InventoryRequestStatus @default(PENDING)

  // Workflow
  requestedBy String
  requester   User     @relation("InventoryRequestRequester", fields: [requestedBy], references: [id])
  requestedAt DateTime @default(now())

  reviewedBy  String?
  reviewer    User?    @relation("InventoryRequestReviewer", fields: [reviewedBy], references: [id])
  reviewedAt  DateTime?
  reviewNotes String?

  deliveredBy String?
  deliverer   User?    @relation("InventoryRequestDeliverer", fields: [deliveredBy], references: [id])
  deliveredAt DateTime?

  // Warehouse delivery tracking (entrega física desde bodega origen)
  warehouseDeliveredBy String?
  warehouseDeliverer   User?    @relation("InventoryRequestWarehouseDeliverer", fields: [warehouseDeliveredBy], references: [id])
  warehouseDeliveredAt DateTime?

  // Destination warehouse receipt (recepción en bodega destino - solo inter-empresa)
  destinationWarehouseReceivedBy String?
  destinationWarehouseReceiver   User?    @relation("InventoryRequestDestinationWarehouseReceiver", fields: [destinationWarehouseReceivedBy], references: [id])
  destinationWarehouseReceivedAt DateTime?

  // Technician receipt confirmation (confirmación de recepción del técnico)
  receivedBy String?
  receiver   User?    @relation("InventoryRequestReceiver", fields: [receivedBy], references: [id])
  receivedAt DateTime?

  // Notes
  notes   String?
  urgency RequestUrgency @default(NORMAL)

  // Inventory movements related to this request
  inventoryMovements InventoryMovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workOrderId])
  @@index([inventoryItemId])
  @@index([status])
  @@index([sourceCompanyId])
  @@index([requestedBy])
  @@index([reviewedBy])
  @@index([deliveredBy])
  @@map("work_order_inventory_requests")
}

model InventoryMovement {
  id String @id @default(cuid())

  // Type
  type MovementType

  // Item
  inventoryItemId String
  inventoryItem   InventoryItem @relation(fields: [inventoryItemId], references: [id])

  // Origin
  fromLocationId   String?
  fromLocationType LocationType?
  fromCompanyId    String?
  fromCompany      Company? @relation("InventoryMovementFromCompany", fields: [fromCompanyId], references: [id])

  // Destination
  toLocationId   String?
  toLocationType LocationType?
  toCompanyId    String?
  toCompany      Company? @relation("InventoryMovementToCompany", fields: [toCompanyId], references: [id])

  // Quantity
  quantity  Int
  unitCost  Float?
  totalCost Float?

  // References
  workOrderId     String?
  workOrder       WorkOrder? @relation(fields: [workOrderId], references: [id])
  requestId       String?
  request         WorkOrderInventoryRequest? @relation(fields: [requestId], references: [id])
  purchaseOrderId String?

  // Details
  reason         String?
  notes          String?
  documentNumber String? // Factura, guía, etc.

  // Audit
  createdBy String
  creator   User   @relation("InventoryMovementCreator", fields: [createdBy], references: [id])
  approvedBy String?
  approver   User?  @relation("InventoryMovementApprover", fields: [approvedBy], references: [id])

  createdAt DateTime @default(now())

  @@index([inventoryItemId])
  @@index([type])
  @@index([createdAt])
  @@index([fromCompanyId])
  @@index([toCompanyId])
  @@index([workOrderId])
  @@index([requestId])
  @@index([createdBy])
  @@index([approvedBy])
  @@map("inventory_movements")
}

// ============================================================================
// BILLING & SUBSCRIPTIONS
// ============================================================================

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE      // Pago atrasado
  CANCELED
  TRIALING      // En período de prueba
  INCOMPLETE    // Pago incompleto
  PAUSED        // Pausado temporalmente
}

enum BillingInterval {
  MONTHLY
  ANNUAL
}

enum PlanTier {
  STARTER
  BUSINESS
  CORPORATE
  ENTERPRISE
  CUSTOM
}

model SubscriptionPlan {
  id          String    @id @default(cuid())
  name        String    @unique // "Starter", "Business", "Corporate"
  tier        PlanTier
  description String?

  // Pricing
  monthlyPrice  Float   // Precio mensual en USD
  annualPrice   Float   // Precio anual en USD (con descuento)

  // Limits
  maxUsers              Int     @default(10)
  maxCompanies          Int     @default(1)      // Para planes Corporate
  maxWarehouses         Int     @default(2)
  maxWorkOrdersPerMonth Int     @default(100)
  maxInventoryItems     Int     @default(200)
  maxStorageGB          Float   @default(5)      // GB de almacenamiento

  // Overage pricing (cargos por exceso)
  overageUserPrice      Float   @default(15)     // USD por usuario extra
  overageStoragePrice   Float   @default(0.50)   // USD por GB extra
  overageWorkOrderPrice Float   @default(1)      // USD por orden extra

  isActive    Boolean   @default(true)
  isPublic    Boolean   @default(true)  // Si se muestra públicamente

  subscriptions Subscription[]
  features      PlanFeature[]  // Features incluidos en este plan

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("subscription_plans")
}

// Tabla intermedia: Features incluidos en cada plan
model PlanFeature {
  id String @id @default(cuid())

  planId String
  plan   SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  module FeatureModule // Feature incluido en el plan

  createdAt DateTime @default(now())

  @@unique([planId, module]) // Un plan no puede tener el mismo feature duplicado
  @@map("plan_features")
}

model Subscription {
  id String @id @default(cuid())

  // Company relationship
  companyId String  @unique
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Plan
  planId String
  plan   SubscriptionPlan @relation(fields: [planId], references: [id])

  // Billing
  status          SubscriptionStatus @default(TRIALING)
  billingInterval BillingInterval    @default(MONTHLY)

  // Pricing (snapshot del plan al momento de subscribirse)
  currentPrice Float

  // Billing cycle
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  trialEnd           DateTime?

  // Cancellation
  cancelAtPeriodEnd Boolean   @default(false)
  canceledAt        DateTime?

  // Stripe integration
  stripeCustomerId       String?  @unique
  stripeSubscriptionId   String?  @unique
  stripePaymentMethodId  String?

  // Usage tracking
  usageMetrics UsageMetrics?
  invoices     Invoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([status])
  @@map("subscriptions")
}

model UsageMetrics {
  id String @id @default(cuid())

  subscriptionId String       @unique
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  // Current usage for billing period
  currentUsers              Int   @default(0)
  currentCompanies          Int   @default(1)
  currentWarehouses         Int   @default(0)
  currentWorkOrdersThisMonth Int   @default(0)
  currentInventoryItems     Int   @default(0)
  currentStorageGB          Float @default(0)

  // Peak usage (for reporting)
  peakUsers         Int   @default(0)
  peakStorageGB     Float @default(0)

  // Last reset (inicio del período de facturación)
  lastResetAt DateTime @default(now())

  // Calculated overages
  overageUsers       Int   @default(0)
  overageStorageGB   Float @default(0)
  overageWorkOrders  Int   @default(0)
  overageCharges     Float @default(0) // Total de cargos por exceso

  updatedAt DateTime @updatedAt

  @@map("usage_metrics")
}

model Invoice {
  id String @id @default(cuid())

  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])

  // Invoice details
  invoiceNumber String   @unique // INV-2024-001
  status        String   // "draft", "open", "paid", "void", "uncollectible"

  // Amounts in USD
  subtotal      Float
  taxAmount     Float    @default(0)
  totalAmount   Float

  // Line items breakdown
  planAmount    Float    // Costo del plan base
  overageAmount Float    @default(0) // Cargos por exceso

  // Billing period
  periodStart   DateTime
  periodEnd     DateTime

  // Payment
  dueDate       DateTime
  paidAt        DateTime?

  // Stripe
  stripeInvoiceId String?  @unique
  stripePaymentIntentId String?

  // PDF
  invoicePdfUrl String?

  // Metadata
  metadata      Json?    // Detalles adicionales

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([subscriptionId])
  @@index([status])
  @@index([createdAt])
  @@map("invoices")
}
